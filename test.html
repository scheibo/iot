<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>iot</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>iot</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'><p><strong>iot</strong> serves as a testing 'framework' for the times when you only care
that given a certain input, a certain output is produced. <code>iot</code> tries to be
a simple solution to creating and managing test suites in this limited
environment. The basic idea behind <code>iot</code> is that it runs a given program and
saves the output (and error) streams, comparing them to the expected output
(and error). iot can handle running entire suites of such tests (i.e.
directories on input files), or simply individual tests.</p>

<p>Installing <code>iot</code> is simple, simply clone the repository and copy (or link)
the 'iot' file to a location on your <code>PATH</code> (like <code>/usr/local</code>, for
example).</p>

<pre><code>$ git clone git://github.com/scheibo/iot.git
$ cd iot
$ [sudo] cp iot /bin/somewhere/on/your/path
$ iot program suite
</code></pre>

<p>This web page was created by running <a href="https://github.com/rtomayko/shocco">shocco</a> against the <code>iot</code> <a href="https://github.com/scheibo/iot">source</a>
file.More information regarding <code>iot</code> can be found in the <a href="https://github.com/scheibo/iot#readme">README</a> or in
the <a href="http://scheibo.github.com/iot/iot.1.html">iot(1)</a> manpage.</p>

</td><td class=code><div class=highlight><pre>
<span class="c">#!/bin/bash</span>

</pre></div></td></tr><tr><td class=docs>

<h2>Usage</h2>

<p>We include this line as a safety precaution -  it's important to exit
immediately if we run into any problems rather than potentially screwing
anything up.</p>

</td><td class=code><div class=highlight><pre>
<span class="nb">set</span> -e

</pre></div></td></tr><tr><td class=docs>

<p>We're going to steal an idea from <a href="https://github.com/rtomayko">rtomyako</a>'s
<a href="https://github.com/rtomayko/shocco">shocco</a> program by including the 'Usage' message as a comment and then
later doing some 'magic' to output as a help message. In order to get around
<code>shocco</code> from parsing it as documentation, we need to include some character
other than a space after the comment.</p>

</td><td class=code><div class=highlight><pre>
<span class="c">#/ Usage: iot &lt;program&gt; &lt;test-suite&gt;...</span>
<span class="c">#/        iot &lt;program&gt; &lt;test-file&gt;...</span>
<span class="c">#/        iot --command=&lt;program_runner&gt; &lt;program&gt; &lt;test-suite&gt;...</span>
<span class="c">#/</span>
<span class="c">#/ Simple test runner for input/output tests. Feeds a given program</span>
<span class="c">#/ input files and compares the output to a set of expected output files.</span>
<span class="c">#/</span>
<span class="c">#/ Configuration options:</span>
<span class="c">#/    -s, --sandboxdir=&lt;dir&gt;  change the default temp directory</span>
<span class="c">#/    -t, --testdir=&lt;dir&gt;                change default test directory</span>
<span class="c">#/    -r, --rootdir=&lt;dir&gt;                change default root directory</span>
<span class="c">#/    -c, --command=&lt;command&gt;            use &lt;command&gt; to run the program</span>
<span class="c">#/    -m, --matcher=&lt;file&gt;               use the custom matchers in &lt;file&gt;</span>
<span class="c">#/</span>
<span class="c">#/ Mode options:</span>
<span class="c">#/    -i, --immediate                    immediately print diagnositc info</span>
<span class="c">#/    -v, --verbose                      more verbose failure program msgs</span>
<span class="c">#/    -x, --sudden-death                 stop after the first failed test</span>
<span class="c">#/    -q, --quiet                        test and return exit code, no output</span>
<span class="c">#/    -u, --unified                      use a unified diff for fail output</span>

</pre></div></td></tr><tr><td class=docs>

<p>Our magic usage function, pretty much straight from <a href="https://github.com/rtomayko/shocco">shocco</a>. We parse our
own file for our comment leader and then print the stripped message.</p>

</td><td class=code><div class=highlight><pre>
usage<span class="o">()</span> <span class="o">{</span>
  grep <span class="s1">&#39;^#/&#39;</span> &lt;<span class="s2">&quot;$0&quot;</span> | cut -c4-
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>

<p>For the error function we print whatever argument we're given and the usage
block. One problem that could result from the use of <code>exit 1</code> is that
another script might misinterpret this to mean a single test failed (since
usually the fail count is the exit code). Changing status with something
like 125 might help, but that's just delaying the issue.</p>

</td><td class=code><div class=highlight><pre>
error<span class="o">()</span> <span class="o">{</span>
  <span class="nb">printf</span> <span class="s2">&quot;${*}\n\n&quot;</span>
  usage
  <span class="nb">exit </span>1
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>

<h2>Pass and Failure Messages</h2>

<p>The default pass and failure messages. We're taking after
<a href="http://rspec.info">RSpec</a> here and simply printing a very minimal
indicator. Specifying <code>-v</code> will get the user more information if they want
it. One thing to note is that the messages will get colored (red and green,
respectively) later on down the line.</p>

</td><td class=code><div class=highlight><pre>
passmsg<span class="o">()</span> <span class="o">{</span> <span class="nb">printf</span> <span class="s2">&quot;.&quot;</span>; <span class="o">}</span>
failmsg<span class="o">()</span> <span class="o">{</span> <span class="nb">printf</span> <span class="s2">&quot;F&quot;</span>; <span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>

<p>There is also the verbose options for the messages. Two things to note are
how we manually include a newline and how we're normalizing the test file
name to remove any leading path or .in cruft.</p>

</td><td class=code><div class=highlight><pre>
verbose_passmsg<span class="o">()</span> <span class="o">{</span>
  <span class="nv">test_name</span><span class="o">=</span><span class="s2">&quot;${1##/*/}&quot;</span>
  <span class="nv">test_name</span><span class="o">=</span><span class="s2">&quot;${test_name%%.in}&quot;</span>
  <span class="nb">printf</span> <span class="s2">&quot;Passed test: $test_name\n&quot;</span>
<span class="o">}</span>
verbose_failmsg<span class="o">()</span> <span class="o">{</span>
  <span class="nv">test_name</span><span class="o">=</span><span class="s2">&quot;${1##/*/}&quot;</span>
  <span class="nv">test_name</span><span class="o">=</span><span class="s2">&quot;${test_name%%.in}&quot;</span>
  <span class="nb">printf</span> <span class="s2">&quot;Failed test: $test_name\n&quot;</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>

<h2>Colors</h2>

<p>In order to change the terminal colors we're going to use tput as opposed to
escape codes (for fun!). We need to be sure to finish with a RESET every
time we change the color or else the color will continue to be used for the
rest of the output (or at least until it is changed again).</p>

</td><td class=code><div class=highlight><pre>
<span class="nv">RED</span><span class="o">=</span><span class="k">$(</span>tput setaf 1<span class="k">)</span>
<span class="nv">GREEN</span><span class="o">=</span><span class="k">$(</span>tput setaf 2<span class="k">)</span>
<span class="nv">YELLOW</span><span class="o">=</span><span class="k">$(</span>tput setaf 3<span class="k">)</span>
<span class="nv">BOLD</span><span class="o">=</span><span class="k">$(</span>tput bold<span class="k">)</span>
<span class="nv">RESET</span><span class="o">=</span><span class="k">$(</span>tput sgr0<span class="k">)</span>

</pre></div></td></tr><tr><td class=docs>

<p>There are helper functions for printing passing, warning and failing
messages. They simply wrap their input in colors. Notice the conspicious use
of <code>printf(1)</code> in all of this code without a <code>\n</code>.</p>

</td><td class=code><div class=highlight><pre>
ppass<span class="o">()</span> <span class="o">{</span> <span class="nb">printf</span> <span class="s2">&quot;${GREEN}${1}${RESET}&quot;</span>; <span class="o">}</span>
pwarn<span class="o">()</span> <span class="o">{</span> <span class="nb">printf</span> <span class="s2">&quot;${YELLOW}${1}${RESET}&quot;</span>; <span class="o">}</span>
pfail<span class="o">()</span> <span class="o">{</span> <span class="nb">printf</span> <span class="s2">&quot;${RED}${1}${RESET}&quot;</span>; <span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>

<h2>Option Processing and Setup</h2>

<p>The code for option processing is pretty self explanatory, just a loop
through the command line arguments, assigning variables and shifting as we
go. The constants determining the path begin undefined - we adjust them
later on if they haven't been set by the user. All of our booleans denote
exceptional cases, so they all start out as false unless changed by the
user.</p>

</td><td class=code><div class=highlight><pre>
<span class="nv">SANDBOXDIR</span><span class="o">=</span>
<span class="nv">TESTDIR</span><span class="o">=</span>
<span class="nv">ROOTDIR</span><span class="o">=</span>
<span class="nv">COMMAND</span><span class="o">=</span>
<span class="nv">immediate</span><span class="o">=</span><span class="nb">false</span>
<span class="nv">verbose</span><span class="o">=</span><span class="nb">false</span>
<span class="nv">sudden_death</span><span class="o">=</span><span class="nb">false</span>
<span class="nv">quiet</span><span class="o">=</span><span class="nb">false</span>
<span class="nv">unified</span><span class="o">=</span><span class="nb">false</span>

</pre></div></td></tr><tr><td class=docs>

<p>It's sometimes difficult to remember all the proper option names, so <code>iot</code>
tries to 'do the Right Thing' if the arguments don't exactly match. Notice,
for example, that 'immeadiate' is provided as an option, as I commonly typo
this.</p>

<p>There's really two types of different parsing techniques going on here, to
deal with the <code>--option</code> and <code>--option=</code> arguments. The straightforward
options just have their argument following them, so we shift twice - once to
eliminate the option and the second time to get rid of the argument. The
<code>--option=</code> type require only one shift since the argument is included in
the name, the only difficulty here is using the special syntax for shell
variables which strips away everything that matches a regex.</p>

<p>This is kind of an ugly looking dense block, and I'm generally not a huge
fan of arbitrary aligning of various lines, but since option parsing is so
repetitive and the code's job is so self explanatory we can save some screen
real estate here.</p>

</td><td class=code><div class=highlight><pre>
<span class="k">while </span><span class="nb">test</span> <span class="nv">$# </span>-gt 0
<span class="k">do</span>
<span class="k">  case</span> <span class="nv">$1</span> in
    -s|--sandboxdir|--tempdir<span class="o">)</span>  <span class="nv">SANDBOXDIR</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>;       <span class="nb">shift </span>2 ;;
    --tempdir<span class="o">=</span>*|--sandboxdir<span class="o">=</span>*<span class="o">)</span> <span class="nv">SANDBOXDIR</span><span class="o">=</span><span class="s2">&quot;${1##*=}&quot;</span>; <span class="nb">shift</span>   ;;

    -t|--testdir<span class="o">)</span> <span class="nv">TESTDIR</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>;                        <span class="nb">shift </span>2 ;;
    --testdir<span class="o">=</span>*<span class="o">)</span>  <span class="nv">TESTDIR</span><span class="o">=</span><span class="s2">&quot;${1##*=}&quot;</span>;                  <span class="nb">shift</span>   ;;

    -r|--root|--rootdir<span class="o">)</span>  <span class="nv">ROOTDIR</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>;                <span class="nb">shift </span>2 ;;
    --root<span class="o">=</span>*|--rootdir<span class="o">=</span>*<span class="o">)</span> <span class="nv">ROOTDIR</span><span class="o">=</span><span class="s2">&quot;${1##*=}&quot;</span>;          <span class="nb">shift</span>   ;;

    -c|--run|--command|<span class="o">)</span> <span class="nv">COMMAND</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>;                 <span class="nb">shift </span>2 ;;
    --run<span class="o">=</span>*|--command<span class="o">=</span>*<span class="o">)</span> <span class="nv">COMMAND</span><span class="o">=</span><span class="s2">&quot;${1##*=}&quot;</span>;           <span class="nb">shift</span>   ;;

    -i|--immediate|--imeadiate<span class="o">)</span> <span class="nv">immediate</span><span class="o">=</span><span class="nb">true</span>;        <span class="nb">shift</span>   ;;
    -v|-vv|--verbose<span class="o">)</span>           <span class="nv">verbose</span><span class="o">=</span><span class="nb">true</span>;          <span class="nb">shift</span>   ;;
    -q|--quiet|--silent<span class="o">)</span>        <span class="nv">quiet</span><span class="o">=</span><span class="nb">true</span>;            <span class="nb">shift</span>   ;;
    -u|--unified<span class="o">)</span>               <span class="nv">unified</span><span class="o">=</span><span class="nb">true</span>;          <span class="nb">shift</span>   ;;
    -x|--sudden-death|--sudden_death|--suddendeath<span class="o">)</span>
                                <span class="nv">sudden_death</span><span class="o">=</span><span class="nb">true</span>;     <span class="nb">shift</span>   ;;

    -h|--help|<span class="s1">&#39;-?&#39;</span>|<span class="s1">&#39;--?&#39;</span><span class="o">)</span> usage <span class="o">&amp;&amp;</span> <span class="nb">exit </span>0                      ;;
    -*<span class="o">)</span> error <span class="s2">&quot;Unrecognized option: ${1}&quot;</span>                      ;;
    *<span class="o">)</span> <span class="nb">break</span>                                                   ;;
  <span class="k">esac</span>
<span class="k">done</span>

</pre></div></td></tr><tr><td class=docs>

<h2>Sandbox and Cleanup</h2>

<p>We need a place to send all the output from the program we're testing before
we can see if it matches the expected output. We'll need a temporary sandbox
directory to do this. We use the <code>:=</code> paramter expansion to make sure
<code>TMPDIR</code> is set. We then try to use <code>mktmp(1)</code> to create the temp directory
if we're lucky enough to have it, otherwise we create our directory far more
insecurely using the programs basename and pid. One thing to note: some
implementations of <code>mktmp(1)</code> require the string of X's and other don't, I
had trouble installing <code>shocco(1)</code> on my machines because of this issue.</p>

</td><td class=code><div class=highlight><pre>
: <span class="k">${</span><span class="nv">TMPDIR</span><span class="p">:=/tmp</span><span class="k">}</span>
: <span class="k">${</span><span class="nv">SANDBOXDIR</span><span class="p">:=</span><span class="k">$(</span>
      <span class="k">if </span><span class="nb">command</span> -v mktemp 1&gt;/dev/null 2&gt;&amp;1
      <span class="k">then</span>
<span class="k">          </span>mktemp -dt <span class="s2">&quot;$(basename $0).XXXXXXXXXXXXX&quot;</span>
      <span class="k">else</span>
<span class="k">          </span><span class="nv">dir</span><span class="o">=</span><span class="s2">&quot;$TMPDIR/$(basename $0).$$&quot;</span>
          mkdir <span class="s2">&quot;$dir&quot;</span>
          <span class="nb">echo</span> <span class="s2">&quot;$dir&quot;</span>
      <span class="k">fi</span>
  <span class="k">)}</span>

</pre></div></td></tr><tr><td class=docs>

<p>Here we perform a bit of a sanity check to make sure we're not using a
stupid location for our temp directory which would result in lots of
potentially nasty things happening.</p>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$SANDBOX&quot;</span> -o <span class="s2">&quot;$WORK&quot;</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">  </span>error <span class="s2">&quot;$(basename $0): could not create a temporary sandbox directory&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>

<p>Most importantly we're going to register an <code>EXIT</code> trap to clean up our temp # directory unless we're killed witbh <code>SIGKILL.</code></p>

<p>All of the code dealing with creating and cleaning up our temporary sandbox # directory comes at you straight out of <a href="https://github.com/rtomayko/shocco">shocco</a>.</p>

</td><td class=code><div class=highlight><pre>
<span class="nb">trap</span> <span class="s2">&quot;rm -rf $SANDBOXDIR&quot;</span> 0

</pre></div></td></tr><tr><td class=docs>

<h2>'Root' Directory</h2>

<p>Here we try to determine where the root directory of the project we're
testing is. We first need to check if if <code>ROOTDIR</code> was already set by the
user through the <code>--rootdir</code> command line option. This leverages the
<code>${var:+val}</code> variable subsititution form which returns its value if
<code>ROOTDIR</code> is defined and not null.We start by defaulting to the current
directory - in the most basic case <code>iot</code> will be run from the top level
directory. However, in order to provide more of a convenience for people
using source control, we'll also check if we're in a <code>hg</code> or <code>git</code>
repository, using the root of that repository as the root directory for the
script. This allows us to call the script anywhere in the project and it
will still be able to find the correct files.</p>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">ROOTDIR</span><span class="p">:+1</span><span class="k">}</span> -eq 1 <span class="o">]</span>; <span class="k">then</span>
<span class="k">  </span><span class="nv">ROOTDIR</span><span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>
  hg root &gt;&amp; <span class="s1">&#39;/dev/null&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">ROOTDIR</span><span class="o">=</span><span class="sb">`</span>hg root<span class="sb">`</span>
  git rev-parse --show-toplevel &gt;&amp; <span class="s1">&#39;/dev/null&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">ROOTDIR</span><span class="o">=</span><span class="sb">`</span>git rev-parse --show-toplevel<span class="sb">`</span>
<span class="k">fi</span>



</pre></div></td></tr><tr><td class=docs>

<h2>Final Preparations</h2>

<p>Main option processing. The first argument to iot is the test file and the rest of the options denote suites
to run. However, we need to take into account the special case where we are given just a program name - in
this case we don't want to shift since that name also needs to be passed in order to name  the suite to run.</p>

</td><td class=code><div class=highlight><pre>
<span class="o">[[</span> -f <span class="s2">&quot;${ROOTDIR}/${1}&quot;</span> <span class="o">]]</span> <span class="o">||</span> usage
<span class="nv">PROGNAME</span><span class="o">=</span><span class="s2">&quot;${ROOTDIR}/${1}&quot;</span>
<span class="o">[[</span> <span class="nv">$# </span>-eq 1 <span class="o">]]</span> <span class="o">||</span> <span class="nb">shift</span>

dotest <span class="nv">$@</span>

</td><td class=code><div class=highlight><pre>
</pre></div></td></tr><tr><td class=docs>

</pre></div></td></tr><tr><td class=docs>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
